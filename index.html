<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>自动化选币器</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div id="progressOverlay" class="progress-overlay hidden" aria-hidden="true">
    <div class="progress-card">
      <div id="progressText" class="progress-text">加载中...</div>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-row">
          <div class="brand-title">自动化选币器</div>
          <button id="themeToggle" class="theme-toggle" title="切换主题">
            <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <!-- Sun -->
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
        </div>
        <div id="status" class="brand-sub"></div>
        <div id="summary" class="brand-sub"></div>
      </div>

      <div class="sidebar-scroll">
        <div class="block">
        <div class="block-title">数据</div>
        <label class="label">市场</label>
        <select id="marketSelect" class="select">
          <option value="all">全市场</option>
          <option value="spot">现货</option>
          <option value="swap">合约</option>
        </select>
        <button id="btnRefresh" class="btn">刷新</button>
      </div>

      <div class="block">
        <div class="block-title">均线趋势</div>
        <div class="group">
          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condCloseMa" type="checkbox" /> 条件1：close &gt; MA</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">MA 周期</span>
                    <input id="maPeriodClose" class="input" type="number" min="2" step="1" value="20" />
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condMa" type="checkbox" /> 条件2：MA(快) &gt; MA(慢)</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">快</span>
                    <input id="maFast" class="input" type="number" min="2" step="1" value="10" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">慢</span>
                    <input id="maSlow" class="input" type="number" min="2" step="1" value="20" />
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condEma" type="checkbox" /> 条件3：close &gt; EMA</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">EMA 周期</span>
                    <input id="emaPeriod" class="input" type="number" min="2" step="1" value="20" />
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condBollUp" type="checkbox" /> 条件4：close &gt; BOLLUP</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">周期</span>
                    <input id="bollPeriod" class="input" type="number" min="2" step="1" value="20" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">标准差</span>
                    <input id="bollStd" class="input" type="number" min="0.1" step="0.1" value="2.0" />
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condBollDown" type="checkbox" /> 条件5：close &lt; BOLLDOWN</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">周期</span>
                    <input id="bollDownPeriod" class="input" type="number" min="2" step="1" value="20" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">标准差</span>
                    <input id="bollDownStd" class="input" type="number" min="0.1" step="0.1" value="2.0" />
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condSuper" type="checkbox" /> 条件6：close &gt; SUPER</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">ATR 周期</span>
                    <input id="superAtrPeriod" class="input" type="number" min="1" step="1" value="10" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">乘数</span>
                    <input id="superMult" class="input" type="number" min="0.1" step="0.1" value="3.0" />
                  </div>
                </div>
              </details>
            </div>
          </div>
        </div>
        <div id="folder_ma_trend" class="folder-conds"></div>
      </div>

      <div class="block">
        <div class="block-title">动量</div>
        <div class="group">
          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condRsi" type="checkbox" /> 条件1：RSI &gt; 阈值</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">RSI 周期</span>
                    <input id="rsiPeriod" class="input" type="number" min="2" step="1" value="14" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">阈值</span>
                    <input id="rsiThreshold" class="input" type="number" min="0" max="100" step="0.1" value="80" />
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condKdj" type="checkbox" /> 条件2：KDJ(K &gt; D)</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">N 周期</span>
                    <input id="kdjN" class="input" type="number" min="1" step="1" value="9" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">M1 周期</span>
                    <input id="kdjM1" class="input" type="number" min="1" step="1" value="3" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">M2 周期</span>
                    <input id="kdjM2" class="input" type="number" min="1" step="1" value="3" />
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condObv" type="checkbox" /> 条件3：OBV &gt; MA</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">MA 周期</span>
                    <input id="obvMaPeriod" class="input" type="number" min="2" step="1" value="20" />
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="cond">
            <div class="cond-top">
              <label class="check"><input id="condStochRsi" type="checkbox" /> 条件4：StochRSI(K &gt; D)</label>
              <details class="details details-inline">
                <summary>参数</summary>
                <div class="param-list">
                  <div class="param-item">
                    <span class="label-inline">RSI 周期</span>
                    <input id="stochRsiP" class="input" type="number" min="2" step="1" value="14" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">Stoch 周期</span>
                    <input id="stochRsiK" class="input" type="number" min="2" step="1" value="14" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">平滑 K</span>
                    <input id="stochRsiSmK" class="input" type="number" min="1" step="1" value="3" />
                  </div>
                  <div class="param-item">
                    <span class="label-inline">平滑 D</span>
                    <input id="stochRsiSmD" class="input" type="number" min="1" step="1" value="3" />
                  </div>
                </div>
              </details>
            </div>
          </div>
        </div>
        <div id="folder_momentum" class="folder-conds"></div>
        <div id="counts" class="counts"></div>
      </div>

      <div id="customFolders" class="group"></div>

      <div class="block">
        <div class="block-title">排序</div>
        <select id="sortKey" class="select"></select>
        <select id="sortOrder" class="select">
          <option value="desc">降序</option>
          <option value="asc">升序</option>
        </select>
      </div>

      <div class="block">
        <div class="block-title-row">
          <div class="block-title">自定义因子（表达式）</div>
          <button id="exprHelp" class="help-btn" type="button" aria-label="帮助">?</button>
        </div>

        <button id="exprToggle" class="btn btn-secondary">添加因子</button>

        <div id="exprEditor" class="group hidden">
        <label class="label">文件夹</label>
        <input id="exprFolder" class="input" type="text" list="folderOptions" value="" placeholder="默认" />
        <datalist id="folderOptions"></datalist>

        <label class="label">因子名</label>
        <input id="exprName" class="input" type="text" value="factor1" />

        <label class="label">表达式</label>
        <textarea id="exprText" class="textarea" rows="3">abs(close.ma(n1)/close.sma(n2)-1)</textarea>

        <div id="exprParams" class="param-list"></div>

        <label class="check"><input id="exprEnable" type="checkbox" /> 启用阈值</label>

        <div id="exprThresholdRow" class="cond-row hidden">
          <span class="label-inline">阈值</span>
          <select id="exprCmp" class="select">
            <option value=">=">&gt;=</option>
            <option value=">">&gt;</option>
            <option value="<=">&lt;=</option>
            <option value="<">&lt;</option>
          </select>
          <input id="exprThreshold" class="input" type="number" step="0.0001" value="0" />
        </div>

        <label class="check"><input id="exprShow" type="checkbox" checked /> 显示列</label>
        <button id="exprAdd" class="btn btn-secondary">添加/更新</button>
        </div>

        <div id="exprList" class="plugin-list"></div>
      </div>

      <div class="block">
        <div class="block-title">显示列配置</div>
        <div id="columnSelector" class="column-selector">
          <!-- 动态生成列勾选框 -->
        </div>
      </div>
    </div>
  </aside>

  <div id="helpModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
        <div class="modal-card">
          <div class="modal-head">
            <div id="helpTitle" class="modal-title">表达式语法</div>
            <button id="helpClose" class="help-close" type="button">×</button>
          </div>
          <div class="modal-body">
            <div class="help-line">必须写 OHLCV 前缀：open/high/low/close/volume/quotevolume，不写默认 close。</div>
            <div class="help-line">方法写法：close.ma(n1)、close.sma(n2)、close.ema(n3)、close.shift(n4)</div>
            <div class="help-line">成交额过滤示例：quotevolume > 1000000（支持自动转为阈值模式）</div>
            <div class="help-line">组合： (close+open).ma(n1) > (close+open).sma(n2)</div>
            <div class="help-line">统计：x.mean(n)、x.std(n)、x.corr(y,n)（注意这些是 rolling 窗口统计）</div>
            <div class="help-line">abs：abs(x)</div>
            <div class="help-line">比较符：&gt;、&gt;=、&lt;、&lt;=、==、!=（返回 1/0）</div>
            <div class="help-line">说明：不支持直接执行 Python 代码；复杂逻辑建议用 factor_plugins 写 Python 因子。</div>
          </div>
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="table-wrap">
        <table class="table">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="./app.js"></script>
</body>
</html>
